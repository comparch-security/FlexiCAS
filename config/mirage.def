namespace mirage;

const AddrWidth = 64;    // 64b addr
const BlockOffset = 6;   // 64B cache block
const L1IW = 6;          // L1 64 sets
const L1WN = 8;          // L1 8 ways
const L1TagOffset = 12;

const LLCPartitionN = 2; // LLC skew partitions
const LLCIW = 14;        // LLC 1024 sets
const LLCWN = 8;         // LLC every skew 8 ways 
const LLCWE = 6;         // LLC every skew 6 ways extra
const LLCWS = 14;        // LLC every skew 8 + 6 = 14 ways all
const LLCTagOffset = 6;  // random index
const LLCWD = 16;        // LLC data ways is LLCPartitionN(2) * LLCWN(8) = 16 
const LLCRW = 0;         // Cuckoo max relocation 

// optimal options
const EnableDelay      = false;  // disable delay estimation
const EnableMonitor    = false;  // disable pfc monitoring
const EnableRelocation = false;  // disable cuckoo relocation

type data_type         = void;

// initiate the L1 cache
type l1_metadata_type   = MetadataMSI(AddrWidth, L1IW, L1TagOffset);
type l1_indexer_type    = IndexNorm(L1IW, BlockOffset);
type l1_replacer_type   = ReplaceLRU(L1IW, L1WN);
type l1_delay_type      = void;
type l1_type            = CacheNorm(L1IW, L1WN, l1_metadata_type, data_type, l1_indexer_type, l1_replacer_type, l1_delay_type, false);
type l1_policy          = MSIPolicy();
type l1_inner_type      = CoreInterfaceMSI(l1_metadata_type, data_type, EnableDelay, false, l1_policy);
type l1_outer_type      = OuterPortMSI(l1_metadata_type, data_type, l1_policy);     // support reverse probe
type l1_cache_type      = CoherentL1CacheNorm(l1_type, l1_outer_type, l1_inner_type);
create l1 = l1_cache_type[1]; // 1 L1 caches

// initiate the llc
type llc_metadata_type   = MirageMetadataMSI(AddrWidth, 0, LLCTagOffset);
type llc_datameta_type   = MirageDataMeta();
type llc_m_indexer_type  = IndexSkewed(LLCIW, BlockOffset, LLCPartitionN);
type llc_d_indexer_type  = IndexRandom(LLCIW, BlockOffset);
type llc_m_replacer_type = ReplaceLRU(LLCWS, LLCWN);
type llc_d_replacer_type = ReplaceCompleteRandom(LLCIW, LLCWD);
type llc_delay_type      = void;
type llc_type            = CacheMirage(LLCIW, LLCWN, LLCWE, LLCPartitionN, llc_metadata_type, data_type, llc_datameta_type, llc_m_indexer_type, llc_d_indexer_type, llc_m_replacer_type, llc_d_replacer_type, llc_delay_type, EnableMonitor);
type llc_policy          = MirageMSIPolicy();
type llc_inner_type      = MirageInnerPortMSIBroadcast(llc_metadata_type, data_type, true, EnableRelocation, LLCRW, llc_policy);
type llc_outer_type      = MirageOuterPortMSIUncached(llc_metadata_type, data_type, llc_policy);
type llc_cache_type      = CoherentCacheNorm(llc_type, llc_outer_type, llc_inner_type);
create llc = llc_cache_type[1]; // 1 shared llc slices

// initiate memory
type memory_delay_type = DelayMemory(100); // 100 cycles for grant to inner
type memory_type       = SimpleMemoryModel(data_type, void);
create mem = memory_type;

connect l1[0:0] -> llc[0];
connect llc -> mem;